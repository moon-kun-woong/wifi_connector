{% extends "base.html" %}

{% block content %}
<p style="margin-bottom: 20px;">
    <strong>{{ phone_number }}</strong>로 발송된 인증번호를 입력해주세요.<br>
    인증번호는 3분간 유효합니다.
</p>

<div id="timer" class="timer">유효시간: <span id="minutes">3</span>:<span id="seconds">00</span></div>

<form id="verify-form">
    <div class="form-group">
        <label for="auth-code">인증번호</label>
        <input type="text" id="auth-code" name="auth-code" placeholder="6자리 인증번호" 
               required maxlength="6" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        <input type="hidden" id="phone-number" value="{{ phone_number }}">
    </div>
    
    <div id="error-message" class="message message-error" style="display: none;"></div>
    
    <button type="submit" class="btn">인증하기</button>
    <a href="/auth" class="btn btn-secondary">다시 인증받기</a>
</form>
{% endblock %}

{% block scripts %}
<script>
    // 3분 타이머 설정
    let totalSeconds = 180; // 3분
    
    const timerInterval = setInterval(function() {
        totalSeconds--;
        
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        
        document.getElementById('minutes').textContent = minutes;
        document.getElementById('seconds').textContent = seconds < 10 ? '0' + seconds : seconds;
        
        if (totalSeconds <= 0) {
            clearInterval(timerInterval);
            document.getElementById('timer').textContent = '인증 시간이 만료되었습니다. 다시 인증해주세요.';
            document.getElementById('timer').style.color = '#e74c3c';
            document.getElementById('auth-code').disabled = true;
        }
    }, 1000);
    
    document.getElementById('verify-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const authCode = document.getElementById('auth-code').value;
        const phoneNumber = document.getElementById('phone-number').value;
        const errorMsg = document.getElementById('error-message');
        
        if (!authCode || authCode.length !== 6 || !/^\d{6}$/.test(authCode)) {
            errorMsg.textContent = '올바른 인증번호를 입력해주세요.';
            errorMsg.style.display = 'block';
            return;
        }
        
        try {
            const response = await fetch('/api/auth/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    phone_number: phoneNumber,
                    auth_code: authCode
                }),
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // 인증 성공 시 성공 페이지로 이동
                window.location.href = '/success';
            } else {
                errorMsg.textContent = data.detail || '인증번호가 일치하지 않습니다. 다시 확인해주세요.';
                errorMsg.style.display = 'block';
            }
        } catch (error) {
            errorMsg.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
            errorMsg.style.display = 'block';
            console.error('Error:', error);
        }
    });
</script>
{% endblock %}
